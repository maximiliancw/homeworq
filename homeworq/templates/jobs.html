{% extends "base.html" %}
{% block title %}Jobs{% endblock %}

{% block content %}
<div x-data="jobsTable()" class="table-container">
    <table id="jobsTable" aria-label="Scheduled Jobs">
        <thead>
            <tr>
                <th>Name</th>
                <th>Task</th>
                <th>Schedule</th>
                <th>Status</th>
                <th>Last Run</th>
                <th>Next Run</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    function jobsTable() {
        return {
            table: null,

            async init() {
                this.table = $('#jobsTable').DataTable({
                    ajax: {
                        url: "/api/jobs",
                        dataSrc: ''
                    },
                    columns: [
                        {
                            data: "uid",
                            render: (data, type, row) => `<kbd>${row.task.name}</kbd>`
                        },
                        {
                            data: "task.name",
                            render: data => data
                        },
                        {
                            data: "schedule",
                            render: data => `<code>${JSON.stringify(data)}</code>`
                        },
                        {
                            data: "enabled",
                            render: data => data ?
                                '<span class="badge success">Enabled</span>' :
                                '<span class="badge error">Disabled</span>'
                        },
                        {
                            data: "last_run",
                            render: data => data ? new Date(data).toLocaleString() : 'Never'
                        },
                        {
                            data: "next_run",
                            render: data => data ? new Date(data).toLocaleString() : 'Not scheduled'
                        },
                        {
                            data: "uid",
                            render: data => `<button class="button button-small" @click="showJobHistory('${data}')">History</button>`
                        }
                    ],
                    order: [[4, 'desc']]
                });

                // Refresh data periodically
                setInterval(() => this.table.ajax.reload(null, false), 30000);
            },

            async showJobHistory(jobUid) {
                try {
                    const response = await fetch(`/api/jobs/${jobUid}/history`);
                    const history = await response.json();

                    showModal(
                        `Job History`,
                        this.formatJobHistory(history)
                    );
                } catch (error) {
                    showToast(`Error fetching job history: ${error.message}`, 'error');
                }
            },

            formatJobHistory(history) {
                return `<table>
                    <thead>
                        <tr>
                            <th>Started</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>Result/Error</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(exec => `
                            <tr>
                                <td>${new Date(exec.started_at).toLocaleString()}</td>
                                <td>${this.getStatusEmoji(exec.status)} ${exec.status}</td>
                                <td>${exec.duration ? `${exec.duration.toFixed(2)}s` : '-'}</td>
                                <td>${exec.error || JSON.stringify(exec.result) || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            },

            getStatusEmoji(status) {
                return {
                    'COMPLETED': '✅',
                    'FAILED': '❌',
                    'RUNNING': '⏳',
                    'PENDING': '⏰'
                }[status] || '❔';
            }
        }
    }
</script>
{% endblock %}