{% extends "base.html" %}
{% block title %}Results{% endblock %}

{% block content %}
<div x-data="resultsTable()" class="table-container">
    <table id="resultsTable" aria-label="Job Execution Results">
        <thead>
            <tr>
                <th>Job</th>
                <th>Task</th>
                <th>Started At</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    function resultsTable() {
        return {
            table: null,

            async init() {
                this.table = $('#resultsTable').DataTable({
                    ajax: {
                        url: "/api/results",
                        dataSrc: ''
                    },
                    columns: [
                        {
                            data: "job.uid",
                            render: (data, type, row) => `<kbd>${data}</kbd>`
                        },
                        { data: "job.task.name" },
                        {
                            data: "started_at",
                            render: data => new Date(data).toLocaleString()
                        },
                        {
                            data: "duration",
                            render: data => data ? `${data.toFixed(2)}s` : '-'
                        },
                        {
                            data: "status",
                            render: data => `${this.getStatusEmoji(data)} ${data}`
                        },
                        {
                            data: null,
                            render: (data, type, row) => {
                                const details = row.error || JSON.stringify(row.result, null, 2) || '-';
                                return `<button class="button button-small" @click="showDetails('${row.job.uid}', ${JSON.stringify(details)})">Details</button>`;
                            }
                        }
                    ],
                    order: [[2, 'desc']]
                });

                // Refresh data periodically
                setInterval(() => this.table.ajax.reload(null, false), 30000);
            },

            showDetails(jobUid, details) {
                showModal(`Execution Details: ${jobUid}`, details);
            },

            getStatusEmoji(status) {
                return {
                    'COMPLETED': '✅',
                    'FAILED': '❌',
                    'RUNNING': '⏳',
                    'PENDING': '⏰'
                }[status] || '❔';
            }
        }
    }
</script>
{% endblock %}