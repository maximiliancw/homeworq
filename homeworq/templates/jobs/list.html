{% extends "_layout.html" %}

{% block title %}Jobs{% endblock %}

{% block content %}
<div x-data="jobsTable()" x-init="init()" class="table-container">
    <table id="jobsTable" aria-label="Scheduled Jobs">
        <thead>
            <tr>
                <th>Name</th>
                <th>Task</th>
                <th>Schedule</th>
                <th>Status</th>
                <th>Last Run</th>
                <th>Next Run</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    function jobsTable() {
        return {
            table: null,

            async init() {
                this.table = $('#jobsTable').DataTable({
                    ajax: {
                        url: "/api/jobs",
                        dataSrc: ''
                    },
                    columns: [
                        {
                            data: "id",
                            render: (data, type, row) => `<kbd>${row.task.name}</kbd>`
                        },
                        { data: "task.name" },
                        {
                            data: "schedule",
                            render: data => data ? `<code>${JSON.stringify(data)}</code>` : 'N/A'
                        },
                        {
                            data: "enabled",
                            render: data => data
                                ? '<span class="badge success">Enabled</span>'
                                : '<span class="badge error">Disabled</span>'
                        },
                        {
                            data: "last_run",
                            render: data => data ? new Date(data).toLocaleString() : 'Never'
                        },
                        {
                            data: "next_run",
                            render: data => data ? new Date(data).toLocaleString() : 'Not scheduled'
                        },
                        {
                            data: "id",
                            render: data => `
                                <button class="button button-small" onclick="showJobHistory('${data}')">History</button>
                                <button class="button button-small error" onclick="deleteJob('${data}')">Delete</button>
                            `
                        }
                    ],
                    order: [[4, 'desc']]
                });

                setInterval(() => {
                    Alpine.store('data').fetchJobs();
                    this.table.ajax.reload(null, false);
                }, 30000);
            },

            async showJobHistory(jobId) {
                try {
                    const response = await fetch(`/api/jobs/${jobId}/history`);
                    const history = await response.json().items;

                    showModal(
                        `Job History`,
                        this.formatJobHistory(history)
                    );
                } catch (error) {
                    showToast(`Error fetching job history: ${error.message}`, 'error');
                }
            },

            async deleteJob(jobId) {
                if (!confirm('Are you sure you want to delete this job?')) return;
                try {
                    const response = await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
                    if (response.ok) {
                        showToast('Job deleted successfully', 'success');
                        await Alpine.store('data').fetchJobs();
                        this.table.ajax.reload(null, false);
                    } else {
                        throw new Error('Failed to delete job');
                    }
                } catch (error) {
                    showToast(`Error deleting job: ${error.message}`, 'error');
                }
            },

            formatJobHistory(history) {
                return `<table>
                    <thead>
                        <tr>
                            <th>Started</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>Result/Error</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(exec => `
                            <tr>
                                <td>${new Date(exec.started_at).toLocaleString()}</td>
                                <td>${this.getStatusEmoji(exec.status)} ${exec.status}</td>
                                <td>${exec.duration ? `${exec.duration.toFixed(2)}s` : '-'}</td>
                                <td>${exec.error || JSON.stringify(exec.result) || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            },

            getStatusEmoji(status) {
                return {
                    'COMPLETED': '✅',
                    'FAILED': '❌',
                    'RUNNING': '⏳',
                    'PENDING': '⏰'
                }[status] || '❔';
            }
        };
    }

    function showModal(title, content) {
        const modal = document.getElementById('modal');
        modal.querySelector('.modal-title').innerText = title;
        modal.querySelector('.modal-body').innerHTML = content;
        modal.showModal();
    }

    function closeModal() {
        const modal = document.getElementById('modal');
        modal.close();
    }
</script>
{% endblock %}