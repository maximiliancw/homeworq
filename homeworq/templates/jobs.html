{% extends "base.html" %}

{% block title %}Jobs{% endblock %}

{% block content %}
<div x-data="jobsTable()" class="table-container">
    <table id="jobsTable" aria-describedby="Scheduled Jobs">
        <thead>
            <tr>
                <th>Name</th>
                <th>Task</th>
                <th>Schedule</th>
                <th>Last Run</th>
                <th>Next Run</th>
                <th>History</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    function jobsTable() {
        return {
            table: null,

            async init() {
                this.table = $('#jobsTable').DataTable({
                    ajax: {
                        url: "/api/jobs",
                        dataSrc: json => Object.entries(json).map(([name, job]) => ({
                            name: name,
                            ...job
                        }))
                    },
                    columns: [
                        { data: "name" },
                        { data: "task.name" },
                        {
                            data: "schedule",
                            render: data => {
                                if (typeof data === 'string') {
                                    return `<code>${data}</code>`;
                                }
                                return `Every ${data.interval} ${data.unit}${data.at ? ` at ${data.at}` : ''}`;
                            }
                        },
                        {
                            data: "last_run",
                            render: data => data ? new Date(data).toLocaleString() : 'Never'
                        },
                        {
                            data: "next_run",
                            render: data => data ? new Date(data).toLocaleString() : 'Not scheduled'
                        },
                        {
                            data: "name",
                            render: data => `<button class="button button-small" @click="showJobHistory('${data}')">History</button>`
                        }
                    ]
                });

                // Refresh data periodically
                setInterval(() => this.table.ajax.reload(null, false), 30000);
            },

            async showJobHistory(jobName) {
                try {
                    const response = await fetch(`/api/jobs/${jobName}/history`);
                    const history = await response.json();

                    const formattedHistory = history.map(execution => ({
                        ...execution,
                        started_at: new Date(execution.started_at).toLocaleString(),
                        completed_at: execution.completed_at ? new Date(execution.completed_at).toLocaleString() : '-',
                        duration: execution.duration ? `${execution.duration.toFixed(2)}s` : '-',
                        status: `${this.getStatusEmoji(execution.status)} ${execution.status}`
                    }));

                    showModal(
                        `Job History: ${jobName}`,
                        `<table>
                        <thead>
                            <tr>
                                <th>Started</th>
                                <th>Completed</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Result/Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${formattedHistory.map(exec => `
                                <tr>
                                    <td>${exec.started_at}</td>
                                    <td>${exec.completed_at}</td>
                                    <td>${exec.duration}</td>
                                    <td>${exec.status}</td>
                                    <td>${exec.error || JSON.stringify(exec.result, null, 2) || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`
                    );
                } catch (error) {
                    showToast(`Error fetching job history: ${error.message}`, 'error');
                }
            },

            getStatusEmoji(status) {
                const emojis = {
                    'pending': '‚è≥',
                    'running': 'üîÑ',
                    'completed': '‚úÖ',
                    'failed': '‚ùå'
                };
                return emojis[status] || '‚ùî';
            }
        }
    }
</script>
{% endblock %}