{% extends "_layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<section x-data="dashboard()" x-init="init()" class="container">
    <!-- Summary Metrics -->
    <div class="grid">
        <article>
            <h3>Tasks</h3>
            <span x-text="$store.data.metrics.totalTasks || '-'"></span>
        </article>
        <article>
            <h3>Jobs</h3>
            <span x-text="$store.data.metrics.activeJobs || '-'"></span>
        </article>
        <article>
            <h3>Results</h3>
            <span x-text="$store.data.metrics.totalExecutions || '-'"></span>
        </article>
        <article>
            <h3>System</h3>
            <kbd x-bind:class="$store.data.health.healthy ? 'pico-background-green-500' : 'pico-background-red-500'"
                x-text="$store.data.health.healthy ? 'healthy' : 'unstable'">
                unknown
            </kbd>
        </article>
    </div>

    <!-- Recent Activity & Next Executions -->
    <div class="grid">
        <article>
            <header>
                <h3>Recent Activity</h3>
            </header>
            <div class="activity-feed">
                <template x-if="$store.data.analytics.recentActivity.length === 0">
                    <p class="text-muted">No recent activity</p>
                </template>
                <template x-for="exec in $store.data.analytics.recentActivity" :key="exec.started_at">
                    <div class="activity-item">
                        <span x-text="getStatusEmoji(exec.status)"></span>
                        <span><strong x-text="exec.job.task.name"></strong></span>
                        <span x-text="formatTimeAgo(exec.started_at)"></span>
                        <span x-show="exec.duration !== null" x-text="formatDuration(exec.duration)"></span>
                    </div>
                </template>
            </div>
        </article>
        <article>
            <header>
                <h3>Upcoming Executions</h3>
            </header>
            <div class="upcoming-list">
                <template x-if="$store.data.analytics.upcomingExecutions.length === 0">
                    <p class="text-muted">No upcoming executions</p>
                </template>
                <template x-for="job in $store.data.analytics.upcomingExecutions" :key="job.id">
                    <div class="upcoming-item">
                        <span><strong x-text="job.task.name"></strong></span>
                        <span x-text="formatDate(job.next_run)"></span>
                    </div>
                </template>
            </div>
        </article>
    </div>

    <!-- Charts -->
    <div class="grid">
        <article>
            <header>
                <h3>Execution History</h3>
            </header>
            <div class="chart-container">
                <canvas id="executionHistoryChart"></canvas>
                <template x-if="!hasExecutionData">
                    <p class="text-muted text-center">No execution data available</p>
                </template>
            </div>
        </article>
        <article>
            <header>
                <h3>Task Distribution</h3>
            </header>
            <div class="chart-container">
                <canvas id="taskDistributionChart"></canvas>
                <template x-if="!hasDistributionData">
                    <p class="text-muted text-center">No distribution data available</p>
                </template>
            </div>
        </article>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function dashboard() {
        return {
            executionHistory: null,
            taskDistribution: null,
            hasExecutionData: false,
            hasDistributionData: false,

            async init() {
                await Alpine.store('data').fetchAll();
                this.initCharts();
                this.updateCharts();

                setInterval(async () => {
                    await Alpine.store('data').fetchAll();
                    this.updateCharts();
                }, 60000);
            },

            initCharts() {
                this.executionHistory = new Chart('executionHistoryChart', {
                    type: 'line',
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });

                this.taskDistribution = new Chart('taskDistributionChart', {
                    type: 'bar',
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, stacked: true },
                            x: { stacked: true }
                        }
                    }
                });
            },

            updateCharts() {
                const history = Alpine.store('data').analytics.executionHistory;
                const distribution = Alpine.store('data').analytics.taskDistribution;

                if (history?.length > 0) {
                    this.hasExecutionData = true;
                    this.executionHistory.data = {
                        labels: history.map(d => d.date),
                        datasets: [{
                            label: 'Completed',
                            data: history.map(d => d.completed),
                            borderColor: '#10b981',
                            fill: false
                        }, {
                            label: 'Failed',
                            data: history.map(d => d.failed),
                            borderColor: '#ef4444',
                            fill: false
                        }]
                    };
                    this.executionHistory.update();
                }

                if (distribution?.length > 0) {
                    this.hasDistributionData = true;
                    this.taskDistribution.data = {
                        labels: distribution.map(d => d.task),
                        datasets: [{
                            label: 'Completed',
                            data: distribution.map(d => d.completed),
                            backgroundColor: '#10b981'
                        }, {
                            label: 'Failed',
                            data: distribution.map(d => d.failed),
                            backgroundColor: '#ef4444'
                        }]
                    };
                    this.taskDistribution.update();
                }
            },

            getStatusEmoji(status) {
                return {
                    'COMPLETED': '✅',
                    'FAILED': '❌',
                    'RUNNING': '⏳',
                    'PENDING': '⏰'
                }[status] || '❔';
            },

            formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - new Date(date)) / 1000);
                const intervals = {
                    year: 31536000,
                    month: 2592000,
                    week: 604800,
                    day: 86400,
                    hour: 3600,
                    minute: 60
                };

                for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                    const interval = Math.floor(seconds / secondsInUnit);
                    if (interval >= 1) {
                        return `${interval} ${unit}${interval === 1 ? '' : 's'} ago`;
                    }
                }
                return 'just now';
            },

            formatDuration(seconds) {
                return `${seconds.toFixed(1)}s`;
            }
        };
    }
</script>
{% endblock %}