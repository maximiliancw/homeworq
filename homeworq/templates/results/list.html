{% extends "_layout.html" %}
{% block title %}Results{% endblock %}

{% block content %}
<div x-data="resultsTable()" x-init="init()" class="table-container">
    <table id="resultsTable" aria-label="Job Execution Results">
        <thead>
            <tr>
                <th>Job</th>
                <th>Started At</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    function resultsTable() {
        return {
            table: null,
            initialized: false,

            async init() {
                if (this.initialized) return;

                this.table = $('#resultsTable').DataTable({
                    ajax: {
                        url: "/api/results",
                        dataSrc: 'items'
                    },
                    columns: [
                        { data: "job.name" },
                        {
                            data: "started_at",
                            render: data => data ? new Date(data).toLocaleString() : 'N/A'
                        },
                        {
                            data: "duration",
                            render: data => data ? `${data.toFixed(2)}s` : '-'
                        },
                        {
                            data: "status",
                            render: data => `${this.getStatusEmoji(data)} ${data}`
                        },
                        {
                            data: null,
                            render: (data, type, row) => {
                                const details = row.error || JSON.stringify(row.result, null, 2) || '-';
                                return `<button class="button button-small" onclick="showDetails('${row.job.id}', '${details.replace(/'/g, "\\'")}')">Details</button>`;
                            }
                        }
                    ],
                    order: [[2, 'desc']]
                });

                this.initialized = true;

                // Set up periodic updates without reinitializing
                setInterval(() => {
                    if (this.table) {
                        Alpine.store('data').fetchExecutions();
                        this.table.ajax.reload(null, false);
                    }
                }, 30000);
            },

            getStatusEmoji(status) {
                return {
                    'COMPLETED': '✅',
                    'FAILED': '❌',
                    'RUNNING': '⏳',
                    'PENDING': '⏰'
                }[status] || '❔';
            }
        }
    }
</script>
{% endblock %}